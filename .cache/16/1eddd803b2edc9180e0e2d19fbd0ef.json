{"id":"nF9o","dependencies":[{"name":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/package.json","includedInParent":true,"mtime":1636789466000},{"name":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/node_modules/@tensorflow-models/facemesh/package.json","includedInParent":true,"mtime":1636887546636},{"name":"@tensorflow/tfjs-core","loc":{"line":17,"column":123},"parent":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/node_modules/@tensorflow-models/facemesh/dist/facemesh.esm.js","resolved":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/node_modules/@tensorflow/tfjs-core/dist/tf-core.esm.js"},{"name":"@tensorflow/tfjs-converter","loc":{"line":17,"column":173},"parent":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/node_modules/@tensorflow-models/facemesh/dist/facemesh.esm.js","resolved":"/Users/kmadasu/kishore/trainings/javascript-gt/gautam/poseanimator/node_modules/@tensorflow/tfjs-converter/dist/tf-converter.esm.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.load=F,exports.FaceMesh=void 0;var t=require(\"@tensorflow/tfjs-core\"),e=require(\"@tensorflow/tfjs-converter\");const s=t=>{t.startEndTensor.dispose(),t.startPoint.dispose(),t.endPoint.dispose()},n=e=>({startEndTensor:e,startPoint:(0,t.slice)(e,[0,0],[-1,2]),endPoint:(0,t.slice)(e,[0,2],[-1,2])}),o=(e,s)=>{const o=(0,t.mul)(e.startPoint,s),i=(0,t.mul)(e.endPoint,s),r=(0,t.concat2d)([o,i],1);return n(r)},i={strides:[8,16],anchors:[2,6]},r=6;function a(t,e,s){const n=[];for(let o=0;o<s.strides.length;o++){const i=s.strides[o],r=Math.floor((e+i-1)/i),a=Math.floor((t+i-1)/i),c=s.anchors[o];for(let t=0;t<r;t++){const e=i*(t+.5);for(let t=0;t<a;t++){const s=i*(t+.5);for(let t=0;t<c;t++)n.push([s,e])}}}return n}function c(e,s,n){const o=(0,t.slice)(e,[0,1],[-1,2]),i=(0,t.add)(o,s),r=(0,t.slice)(e,[0,3],[-1,2]),a=(0,t.div)(r,n),c=(0,t.div)(i,n),l=(0,t.div)(a,2),h=(0,t.sub)(c,l),d=(0,t.add)(c,l),u=(0,t.mul)(h,n),p=(0,t.mul)(d,n);return(0,t.concat2d)([u,p],1)}function l(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}function h(e,s){let n,o,i;if(e.topLeft instanceof t.Tensor&&e.bottomRight instanceof t.Tensor){const[r,a]=(0,t.tidy)(()=>[(0,t.concat)([(0,t.sub)(s-1,e.topLeft.slice(0,1)),e.topLeft.slice(1,1)]),(0,t.concat)([(0,t.sub)(s-1,e.bottomRight.slice(0,1)),e.bottomRight.slice(1,1)])]);n=r,o=a,null!=e.landmarks&&(i=(0,t.tidy)(()=>{const n=(0,t.sub)((0,t.tensor1d)([s-1,0]),e.landmarks),o=(0,t.tensor1d)([1,-1]);return(0,t.mul)(n,o)}))}else{const[t,r]=e.topLeft,[a,c]=e.bottomRight;n=[s-1-t,r],o=[s-1-a,c],null!=e.landmarks&&(i=e.landmarks.map(t=>[s-1-t[0],t[1]]))}const r={topLeft:n,bottomRight:o};return null!=i&&(r.landmarks=i),null!=e.probability&&(r.probability=e.probability instanceof t.Tensor?e.probability.clone():e.probability),r}function d(e,s){return(0,t.tidy)(()=>{let t;return t=e.hasOwnProperty(\"box\")?e.box:e,o(t,s).startEndTensor.squeeze()})}class u{constructor(e,s,n,o,r,c){this.blazeFaceModel=e,this.width=s,this.height=n,this.maxFaces=o,this.anchorsData=a(s,n,i),this.anchors=(0,t.tensor2d)(this.anchorsData),this.inputSizeData=[s,n],this.inputSize=(0,t.tensor1d)([s,n]),this.iouThreshold=r,this.scoreThreshold=c}async getBoundingBoxes(e,s,o=!0){const[i,a,l]=(0,t.tidy)(()=>{const s=e.resizeBilinear([this.width,this.height]),n=(0,t.mul)((0,t.sub)(s.div(255),.5),2),o=this.blazeFaceModel.predict(n).squeeze(),i=c(o,this.anchors,this.inputSize),r=(0,t.slice)(o,[0,0],[-1,1]);return[o,i,(0,t.sigmoid)(r).squeeze()]}),h=console.warn;console.warn=(()=>{});const d=t.image.nonMaxSuppression(a,l,this.maxFaces,this.iouThreshold,this.scoreThreshold);console.warn=h;const u=await d.array();d.dispose();let p=u.map(e=>(0,t.slice)(a,[e,0],[1,-1]));s||(p=await Promise.all(p.map(async t=>{const e=await t.array();return t.dispose(),e})));const f=e.shape[1],m=e.shape[2];let g;g=s?(0,t.div)([m,f],this.inputSize):[m/this.inputSizeData[0],f/this.inputSizeData[1]];const b=[];for(let c=0;c<p.length;c++){const e=p[c],a=(0,t.tidy)(()=>{const a=n(e instanceof t.Tensor?e:(0,t.tensor2d)(e));if(!o)return a;const h=u[c];let d;return d=s?this.anchors.slice([h,0],[1,2]):this.anchorsData[h],{box:a,landmarks:(0,t.slice)(i,[h,r-1],[1,-1]).squeeze().reshape([r,-1]),probability:(0,t.slice)(l,[h],[1]),anchor:d}});b.push(a)}return a.dispose(),l.dispose(),i.dispose(),{boxes:b,scaleFactor:g}}async estimateFaces(e,n=!1,o=!1,i=!0){const[,r]=l(e),a=(0,t.tidy)(()=>(e instanceof t.Tensor||(e=t.browser.fromPixels(e)),e.toFloat().expandDims(0))),{boxes:c,scaleFactor:u}=await this.getBoundingBoxes(a,n,i);return a.dispose(),n?c.map(t=>{const e=d(t,u);let s={topLeft:e.slice([0],[2]),bottomRight:e.slice([2],[2])};if(i){const{landmarks:e,probability:n,anchor:o}=t,i=e.add(o).mul(u);s.landmarks=i,s.probability=n}return o&&(s=h(s,r)),s}):Promise.all(c.map(async t=>{const e=d(t,u);let n;if(i){const[o,i,r]=await Promise.all([t.landmarks,e,t.probability].map(async t=>t.array())),a=t.anchor,[c,l]=u,h=o.map(t=>[(t[0]+a[0])*c,(t[1]+a[1])*l]);n={topLeft:i.slice(0,2),bottomRight:i.slice(2),landmarks:h,probability:r},s(t.box),t.landmarks.dispose(),t.probability.dispose()}else{const t=await e.array();n={topLeft:t.slice(0,2),bottomRight:t.slice(2)}}return e.dispose(),o&&(n=h(n,r)),n}))}}const p=\"https://tfhub.dev/tensorflow/tfjs-model/blazeface/1/default/1\";async function f({maxFaces:t=10,inputWidth:s=128,inputHeight:n=128,iouThreshold:o=.3,scoreThreshold:i=.75}={}){const r=await(0,e.loadGraphModel)(p,{fromTFHub:!0});return new u(r,s,n,t,o,i)}const m={silhouette:[10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109],lipsUpperOuter:[61,185,40,39,37,0,267,269,270,409,291],lipsLowerOuter:[146,91,181,84,17,314,405,321,375,291],lipsUpperInner:[78,191,80,81,82,13,312,311,310,415,308],lipsLowerInner:[78,95,88,178,87,14,317,402,318,324,308],rightEyeUpper0:[246,161,160,159,158,157,173],rightEyeLower0:[33,7,163,144,145,153,154,155,133],rightEyeUpper1:[247,30,29,27,28,56,190],rightEyeLower1:[130,25,110,24,23,22,26,112,243],rightEyeUpper2:[113,225,224,223,222,221,189],rightEyeLower2:[226,31,228,229,230,231,232,233,244],rightEyeLower3:[143,111,117,118,119,120,121,128,245],rightEyebrowUpper:[156,70,63,105,66,107,55,193],rightEyebrowLower:[35,124,46,53,52,65],leftEyeUpper0:[466,388,387,386,385,384,398],leftEyeLower0:[263,249,390,373,374,380,381,382,362],leftEyeUpper1:[467,260,259,257,258,286,414],leftEyeLower1:[359,255,339,254,253,252,256,341,463],leftEyeUpper2:[342,445,444,443,442,441,413],leftEyeLower2:[446,261,448,449,450,451,452,453,464],leftEyeLower3:[372,340,346,347,348,349,350,357,465],leftEyebrowUpper:[383,300,293,334,296,336,285,417],leftEyebrowLower:[265,353,276,283,282,295],midwayBetweenEyes:[168],noseTip:[1],noseBottom:[2],noseRightCorner:[98],noseLeftCorner:[327],rightCheek:[205],leftCheek:[425]};function g(t){null!=t&&null!=t.startPoint&&(t.startEndTensor.dispose(),t.startPoint.dispose(),t.endPoint.dispose())}function b(e,s,n){return{startEndTensor:e,startPoint:null!=s?s:(0,t.slice)(e,[0,0],[-1,2]),endPoint:null!=n?n:(0,t.slice)(e,[0,2],[-1,2])}}function y(e,s){const n=(0,t.mul)(e.startPoint,s),o=(0,t.mul)(e.endPoint,s);return b((0,t.concat2d)([n,o],1))}function x(e){return(0,t.tidy)(()=>{const s=(0,t.sub)(e.endPoint,e.startPoint);return(0,t.abs)(s)})}function w(e){return(0,t.tidy)(()=>{const s=(0,t.div)((0,t.sub)(e.endPoint,e.startPoint),2);return(0,t.add)(e.startPoint,s)})}function P(e,s,n){const o=s.shape[1],i=s.shape[2],r=e.startEndTensor;return(0,t.tidy)(()=>{const e=(0,t.concat2d)([r.slice([0,1],[-1,1]),r.slice([0,0],[-1,1]),r.slice([0,3],[-1,1]),r.slice([0,2],[-1,1])],0),a=(0,t.div)(e.transpose(),[o,i,o,i]);return t.image.cropAndResize(s,a,[0],n)})}function E(e,s=1.5){return(0,t.tidy)(()=>{const n=w(e),o=x(e),i=(0,t.mul)((0,t.div)(o,2),s),r=(0,t.sub)(n,i),a=(0,t.add)(n,i);return b((0,t.concat2d)([r,a],1),r,a)})}const O=468,I=.25;class L{constructor(t,e,s,n,o,i){this.regionsOfInterest=[],this.runsWithoutFaceDetector=0,this.boundingBoxDetector=t,this.meshDetector=e,this.meshWidth=s,this.meshHeight=n,this.maxContinuousChecks=o,this.maxFaces=i}async predict(e){if(this.shouldUpdateRegionsOfInterest()){const t=!0,s=!1,{boxes:n,scaleFactor:o}=await this.boundingBoxDetector.getBoundingBoxes(e,t,s);if(0===n.length)return o.dispose(),this.clearAllRegionsOfInterest(),null;const i=n.map(t=>E(y(t,o)));n.forEach(g),this.updateRegionsOfInterest(i),this.runsWithoutFaceDetector=0}else this.runsWithoutFaceDetector++;return(0,t.tidy)(()=>this.regionsOfInterest.map((s,n)=>{const o=P(s,e,[this.meshHeight,this.meshWidth]).div(255),[,i,r]=this.meshDetector.predict(o),a=(0,t.reshape)(r,[-1,3]),c=(0,t.div)(x(s),[this.meshWidth,this.meshHeight]),l=(0,t.mul)(a,c.concat((0,t.tensor2d)([1],[1,1]),1)).add(s.startPoint.concat((0,t.tensor2d)([0],[1,1]),1)),h=this.calculateLandmarksBoundingBox(l);return g(this.regionsOfInterest[n]),this.regionsOfInterest[n]=h,{coords:a,scaledCoords:l,box:h,flag:i.squeeze()}}))}updateRegionsOfInterest(t){for(let e=0;e<t.length;e++){const s=t[e],n=this.regionsOfInterest[e];let o=0;if(n&&n.startPoint){const[t,e,i,r]=s.startEndTensor.arraySync()[0],[a,c,l,h]=n.startEndTensor.arraySync()[0],d=Math.max(t,a),u=Math.max(e,c),p=(Math.min(i,l)-d)*(Math.min(r,h)-u);o=p/((i-t)*(r-e)+(l-a)*(h-e)-p)}o>I?g(s):(this.regionsOfInterest[e]=s,g(n))}for(let e=t.length;e<this.regionsOfInterest.length;e++)g(this.regionsOfInterest[e]);this.regionsOfInterest=this.regionsOfInterest.slice(0,t.length)}clearRegionOfInterest(t){null!=this.regionsOfInterest[t]&&(g(this.regionsOfInterest[t]),this.regionsOfInterest=[...this.regionsOfInterest.slice(0,t),...this.regionsOfInterest.slice(t+1)])}clearAllRegionsOfInterest(){for(let t=0;t<this.regionsOfInterest.length;t++)g(this.regionsOfInterest[t]);this.regionsOfInterest=[]}shouldUpdateRegionsOfInterest(){const t=this.regionsOfInterest.length,e=0===t;return 1===this.maxFaces||e?e:t!==this.maxFaces&&this.runsWithoutFaceDetector>=this.maxContinuousChecks}calculateLandmarksBoundingBox(e){const s=e.slice([0,0],[O,1]),n=e.slice([0,1],[O,1]);return E(b((0,t.stack)([s.min(),n.min(),s.max(),n.max()]).expandDims(0)))}}const T=\"https://tfhub.dev/mediapipe/tfjs-model/facemesh/1/default/1\",B=192,R=192;async function F({maxContinuousChecks:t=5,detectionConfidence:e=.9,maxFaces:s=10,iouThreshold:n=.3,scoreThreshold:o=.75}={}){const[i,r]=await Promise.all([C(s,n,o),M()]);return new v(i,r,t,e,s)}async function C(t,e,s){return f({maxFaces:t,iouThreshold:e,scoreThreshold:s})}async function M(){return(0,e.loadGraphModel)(T,{fromTFHub:!0})}function D(e){return e instanceof t.Tensor?[e.shape[0],e.shape[1]]:[e.height,e.width]}function k(e,s){if(e.mesh instanceof t.Tensor){const[n,o,i,r]=(0,t.tidy)(()=>{const n=(0,t.tensor1d)([s-1,0,0]),o=(0,t.tensor1d)([1,-1,1]);return(0,t.tidy)(()=>[(0,t.concat)([(0,t.sub)(s-1,e.boundingBox.topLeft.slice(0,1)),e.boundingBox.topLeft.slice(1,1)]),(0,t.concat)([(0,t.sub)(s-1,e.boundingBox.bottomRight.slice(0,1)),e.boundingBox.bottomRight.slice(1,1)]),(0,t.sub)(n,e.mesh).mul(o),(0,t.sub)(n,e.scaledMesh).mul(o)])});return Object.assign({},e,{boundingBox:{topLeft:n,bottomRight:o},mesh:i,scaledMesh:r})}return Object.assign({},e,{boundingBox:{topLeft:[s-1-e.boundingBox.topLeft[0],e.boundingBox.topLeft[1]],bottomRight:[s-1-e.boundingBox.bottomRight[0],e.boundingBox.bottomRight[1]]},mesh:e.mesh.map(t=>{const e=t.slice(0);return e[0]=s-1-t[0],e}),scaledMesh:e.scaledMesh.map(t=>{const e=t.slice(0);return e[0]=s-1-t[0],e})})}class v{constructor(t,e,s,n,o){this.pipeline=new L(t,e,B,R,s,o),this.detectionConfidence=n}static getAnnotations(){return m}async estimateFaces(e,s=!1,n=!1){const[,o]=D(e),i=(0,t.tidy)(()=>(e instanceof t.Tensor||(e=t.browser.fromPixels(e)),e.toFloat().expandDims(0))),r=(0,t.env)().get(\"WEBGL_PACK_DEPTHWISECONV\");(0,t.env)().set(\"WEBGL_PACK_DEPTHWISECONV\",!0);const a=await this.pipeline.predict(i);return(0,t.env)().set(\"WEBGL_PACK_DEPTHWISECONV\",r),i.dispose(),null!=a&&a.length>0?Promise.all(a.map(async(t,e)=>{const{coords:i,scaledCoords:r,box:a,flag:c}=t;let l=[c];s||(l=l.concat([i,r,a.startPoint,a.endPoint]));const h=await Promise.all(l.map(async t=>t.array())),d=h[0];if(c.dispose(),d<this.detectionConfidence&&this.pipeline.clearRegionOfInterest(e),s){const t={faceInViewConfidence:d,mesh:i,scaledMesh:r,boundingBox:{topLeft:a.startPoint.squeeze(),bottomRight:a.endPoint.squeeze()}};return n?k(t,o):t}const[u,p,f,g]=h.slice(1);r.dispose(),i.dispose();let b={faceInViewConfidence:d,boundingBox:{topLeft:f,bottomRight:g},mesh:u,scaledMesh:p};n&&(b=k(b,o));const y={};for(const s in m)y[s]=m[s].map(t=>b.scaledMesh[t]);return b.annotations=y,b})):[]}}exports.FaceMesh=v;"},"sourceMaps":null,"error":null,"hash":"bfa8863a10a62e548022e018dd81d8ec","cacheData":{"env":{}}}